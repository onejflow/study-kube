# Volume

emptyDir: 컨테이너끼리 데이터 공유, pod와 수명을 함께하여 pod 삭제 시 데이터 삭제
hostPath: 호스트의 특정 폴더를 파드에 마운트
    - pod 입장에서는 pod가 죽어서 재생성, 또는 장애로 인해 옮겨 졌을때 해당 노드에 재생성되지 않을 수 있음, 그렇게 된다면 pod가 올라가져 있는 노드가 만약에 다른경우 볼륨에 바로 접근을 하지 못함
    - 노드 추가시마다 mount를 걸어주면 되지만 쿠버네티스가 해주는게 아니라 리눅스 단에 직접 설정해야하므로 비추천함
PVC/PV: PV는 실제 스토리지 자원 , PVC는 스토리지 요청서
    - pv는 추상화된 스토리지 객체

| 종류       | 데이터 저장 위치            | 데이터 수명                      | 용도                    |
| -------- | -------------------- | --------------------------- | --------------------- |
| emptyDir | 파드 내부 (임시)           | 파드 삭제 시 삭제됨                 | 임시 캐시, 컨테이너 간 데이터 공유  |
| hostPath | 노드(서버)의 디스크          | 노드에 남음 (단, 다른 노드로 가면 없음)    | 시스템 모니터링, 로컬 테스트      |
| PVC / PV | 별도 스토리지 (AWS, NAS 등) | 영구 보존 (파드가 죽어도, 노드가 바껴도 안전) | DB, 파일 서버, 중요한 운영 데이터 |

- pv의 경우 로컬 볼륨도 있고 원격 형태의 볼륨들도 사용

- Pod에 영구적인 Volume을 할당하기 위한 리소스로 Pod -> PVC -> PV(Volume) 순으로 연결
- Pod가 삭제됐다 재생성되어도, PVC/PV를 통해 지정된 Volume에 연결됨
- PVC와 PV는 capacity와 accessMode를 기준으로 연결됨 
    - pvc를 개발자(유저)가 작성한다면 pv는 admin이 설정

## emptyDir

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-volume-1
spec:
  containers:
  - name: container1
    image: kubetm/init
    volumeMounts:
    - name: empty-dir
      mountPath: /mount1
  - name: container2
    image: kubetm/init
    volumeMounts:
    - name: empty-dir
      mountPath: /mount2
  volumes:
  - name : empty-dir
    emptyDir: {}
```

Pod(container1) 내부로 들어가서 Mount 상태 확인 및 파일 생성

```shell
ls
mount | grep mount1
cd mount1
echo "file context" >> file.txt 
```

 Pod(container2) 내부로 들어가서 파일 동기화 확인

```shell
ls
cd mount2 
ls
cat file.txt
 ```

 ## hostPath

- type 옵션
    - DirectoryOrCreate (실제 경로가 없다면 생성)
    - Directory (실제 경로가 있어야됨)
    - FileOrCreate (실제 경로에 파일이 없다면 생성)
    - File (실제 파일이 었어야함)

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-volume-2
spec:
  nodeSelector:
    kubernetes.io/hostname: k8s-worker1
  containers:
  - name: container
    image: kubetm/init
    volumeMounts:
    - name: host-path
      mountPath: /mount1
  volumes:
  - name : host-path
    hostPath:
      path: /node-v
      type: DirectoryOrCreate
```

## PVC/PV 

생성시 [PV -> PVC -> Pod] 순으로, 삭제시 [Pod -> PVC -> PV] 순으로 삭제

- PersistentVolume

```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv-01
spec:
  capacity:
    storage: 1G
  accessModes:
  - ReadWriteOnce
  local:
    path: /node-v
  nodeAffinity:
    required:
      nodeSelectorTerms:
      - matchExpressions:
        - {key: kubernetes.io/hostname, operator: In, values: [k8s-worker1]}
```

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pvc-01
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 1G
  storageClassName: ""
```

PV/PVC를 label과 selector를 이용해 연결하는 방법

```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv-05
  labels:
    pv: pv-05
spec:
  capacity:
    storage: 1G
  accessModes:
  - ReadWriteOnce
  local:
    path: /node-v
  nodeAffinity:
    required:
      nodeSelectorTerms:
      - matchExpressions:
        - {key: kubernetes.io/hostname, operator: In, values: [k8s-worker1]}
```

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pvc-05
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 1G
  storageClassName: ""
  selector:
    matchLabels:
      pv: pv-05
```